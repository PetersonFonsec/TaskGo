# Imagem base com glibc (melhor p/ Prisma) + apt
FROM node:22-bookworm-slim

# Instala OpenSSL (necessário para o Prisma engine)
RUN apt-get update -y && \
    apt-get install -y openssl && \
    rm -rf /var/lib/apt/lists/*

# Diretório de trabalho
WORKDIR /usr/src/app

# Copia apenas package.json + package-lock (se tiver)
COPY package*.json ./

# Instala dependências (inclui prisma e @prisma/client)
RUN npm install

# Agora copia o restante do código
COPY . .

# Gera o Prisma Client na build (usa o schema configurado no package.json)
RUN npx prisma generate

# Gera alguns registros previamente (só para ter algum conteudo para interagir)
# RUN npx prisma migrate reset --force

# Porta da API Nest
EXPOSE 3000

# Usa o prestart:dev (que roda prisma migrate deploy) + start:dev
CMD ["npm", "run", "start:dev"]
